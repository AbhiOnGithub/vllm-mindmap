<mxfile host="draw.io" modified="2026-02-15" agent="vllm-mindmap" version="24.0.0" type="device">
  <diagram name="Request Lifecycle" id="lifecycle">
    <mxGraphModel dx="700" dy="1100" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="700" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <mxCell id="title" value="vLLM Request Lifecycle (12 Steps)" style="text;html=1;fontSize=18;fontStyle=1;align=center;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="100" y="10" width="500" height="30" as="geometry"/>
        </mxCell>

        <!-- Step 1-3: API Layer (Blue) -->
        <mxCell id="s1" value="1. HTTP POST /v1/chat/completions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="55" width="340" height="38" as="geometry"/>
        </mxCell>
        <mxCell id="s2" value="2. FastAPI Handler — Validate, render chat template" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="113" width="340" height="38" as="geometry"/>
        </mxCell>
        <mxCell id="s3" value="3. InputProcessor — Tokenize + multimodal preprocess" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="171" width="340" height="38" as="geometry"/>
        </mxCell>

        <!-- Step 4: ZMQ Transport (Purple) -->
        <mxCell id="s4" value="4. AsyncLLM.add_request() — send via ZMQ" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#7030A0;fontColor=#FFFFFF;strokeColor=#4A1F6B;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="229" width="340" height="38" as="geometry"/>
        </mxCell>

        <!-- ZMQ boundary -->
        <mxCell id="zmq_sep" value="─── ZMQ / IPC boundary ───" style="text;html=1;fontSize=10;fontStyle=1;fontColor=#FF4444;align=center;" vertex="1" parent="1">
          <mxGeometry x="200" y="276" width="240" height="16" as="geometry"/>
        </mxCell>

        <!-- Steps 5-7: Engine Layer (Green) -->
        <mxCell id="s5" value="5. Scheduler.add_request() — waiting queue, block hashes" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="302" width="340" height="38" as="geometry"/>
        </mxCell>
        <mxCell id="s6" value="6. Scheduler.schedule() — allocate KV blocks, preempt" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="360" width="340" height="38" as="geometry"/>
        </mxCell>
        <mxCell id="s7" value="7. Executor — dispatch to GPU Workers" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="418" width="340" height="38" as="geometry"/>
        </mxCell>

        <!-- GPU boundary -->
        <mxCell id="gpu_sep" value="─── GPU boundary ───" style="text;html=1;fontSize=10;fontStyle=1;fontColor=#FF4444;align=center;" vertex="1" parent="1">
          <mxGeometry x="220" y="465" width="200" height="16" as="geometry"/>
        </mxCell>

        <!-- Steps 8-9: GPU Layer (Orange) -->
        <mxCell id="s8" value="8. GPUModelRunner.execute_model()&#xa;Embedding → Transformer → Output proj → PagedAttention" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ED7D31;fontColor=#FFFFFF;strokeColor=#C55A11;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="491" width="340" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="s9" value="9. Sampler.forward(logits)&#xa;Penalties → Temperature → Top-k/p → Sample token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ED7D31;fontColor=#FFFFFF;strokeColor=#C55A11;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="561" width="340" height="50" as="geometry"/>
        </mxCell>

        <!-- Back to engine -->
        <mxCell id="eng_sep" value="─── back to EngineCore ───" style="text;html=1;fontSize=10;fontStyle=1;fontColor=#FF4444;align=center;" vertex="1" parent="1">
          <mxGeometry x="210" y="620" width="220" height="16" as="geometry"/>
        </mxCell>

        <!-- Step 10: Engine update (Green) -->
        <mxCell id="s10" value="10. Scheduler.update_from_output() — append token, check stop" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="646" width="340" height="38" as="geometry"/>
        </mxCell>

        <!-- Steps 11-12: Output (Blue) -->
        <mxCell id="s11" value="11. OutputProcessor — Detokenize, stream delta" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="150" y="704" width="340" height="38" as="geometry"/>
        </mxCell>
        <mxCell id="s12" value="12. HTTP Response / SSE Stream to client" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="150" y="762" width="340" height="38" as="geometry"/>
        </mxCell>

        <!-- Loop annotation -->
        <mxCell id="loop_text" value="Repeat 6→10&#xa;per token" style="text;html=1;fontSize=11;fontStyle=1;fontColor=#548235;align=center;" vertex="1" parent="1">
          <mxGeometry x="530" y="490" width="90" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="loop_arrow" style="endArrow=block;dashed=1;strokeColor=#548235;strokeWidth=2;curved=1;exitX=1;exitY=0.5;entryX=1;entryY=0.5;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="665" as="sourcePoint"/>
            <mxPoint x="500" y="379" as="targetPoint"/>
            <Array as="points">
              <mxPoint x="540" y="665"/>
              <mxPoint x="540" y="379"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- All arrows with proper strokeColor and strokeWidth -->
        <mxCell id="a1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#2F5496;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s1" target="s2"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#2F5496;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s2" target="s3"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#4A1F6B;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s3" target="s4"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a4" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s4" target="s5"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s5" target="s6"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s6" target="s7"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#C55A11;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s7" target="s8"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a8" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#C55A11;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s8" target="s9"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s9" target="s10"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#2F5496;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s10" target="s11"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#2F5496;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="s11" target="s12"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Color legend -->
        <mxCell id="leg_blue" value="Blue = API Layer" style="text;html=1;fontSize=9;fontStyle=1;fontColor=#4472C4;align=left;" vertex="1" parent="1">
          <mxGeometry x="30" y="830" width="120" height="15" as="geometry"/>
        </mxCell>
        <mxCell id="leg_purple" value="Purple = Transport" style="text;html=1;fontSize=9;fontStyle=1;fontColor=#7030A0;align=left;" vertex="1" parent="1">
          <mxGeometry x="160" y="830" width="120" height="15" as="geometry"/>
        </mxCell>
        <mxCell id="leg_green" value="Green = Engine" style="text;html=1;fontSize=9;fontStyle=1;fontColor=#70AD47;align=left;" vertex="1" parent="1">
          <mxGeometry x="290" y="830" width="110" height="15" as="geometry"/>
        </mxCell>
        <mxCell id="leg_orange" value="Orange = GPU" style="text;html=1;fontSize=9;fontStyle=1;fontColor=#ED7D31;align=left;" vertex="1" parent="1">
          <mxGeometry x="410" y="830" width="100" height="15" as="geometry"/>
        </mxCell>

        <!-- Footer -->
        <mxCell id="ref" value="Ref: docs.vllm.ai/en/latest/ → Design Documents → Architecture Overview" style="text;html=1;fontSize=9;fontStyle=2;fontColor=#A5A5A5;align=center;" vertex="1" parent="1">
          <mxGeometry x="130" y="855" width="400" height="15" as="geometry"/>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
