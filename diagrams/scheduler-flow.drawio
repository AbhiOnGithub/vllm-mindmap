<mxfile host="draw.io" modified="2026-02-15" agent="vllm-mindmap" version="24.0.0" type="device">
  <diagram id="sched" name="Scheduler Flow">
    <mxGraphModel dx="1100" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1000" pageHeight="700" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <mxCell id="title" value="vLLM Scheduler Flow (every engine step)" style="text;html=1;fontSize=18;fontStyle=1;align=center;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="200" y="10" width="600" height="30" as="geometry"/>
        </mxCell>

        <!-- Step 1: Resume running -->
        <mxCell id="step1" value="1. Resume RUNNING requests&#xa;(allocate 1 decode token each)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="60" width="300" height="50" as="geometry"/>
        </mxCell>

        <!-- Decision 1 -->
        <mxCell id="dec1" value="KV cache&#xa;space?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFC000;fontColor=#333333;strokeColor=#BF9000;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="365" y="140" width="130" height="65" as="geometry"/>
        </mxCell>

        <!-- Preempt (right side) -->
        <mxCell id="preempt" value="PREEMPT&#xa;lowest priority request" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FF4444;fontColor=#FFFFFF;strokeColor=#CC0000;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="700" y="145" width="180" height="50" as="geometry"/>
        </mxCell>

        <!-- Step 2: Admit waiting -->
        <mxCell id="step2" value="2. Admit WAITING requests&#xa;(allocate prefill blocks)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4472C4;fontColor=#FFFFFF;strokeColor=#2F5496;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="245" width="300" height="50" as="geometry"/>
        </mxCell>

        <!-- Decision 2 -->
        <mxCell id="dec2" value="Blocks&#xa;free?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFC000;fontColor=#333333;strokeColor=#BF9000;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="365" y="330" width="130" height="65" as="geometry"/>
        </mxCell>

        <!-- Stop admitting (right side) -->
        <mxCell id="stop_admit" value="Stop admitting&#xa;(wait for next step)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#A5A5A5;fontColor=#FFFFFF;strokeColor=#757575;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="700" y="338" width="180" height="45" as="geometry"/>
        </mxCell>

        <!-- Step 3: Build output -->
        <mxCell id="step3" value="3. Build SchedulerOutput → send to Executor" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="435" width="300" height="45" as="geometry"/>
        </mxCell>

        <!-- Step 4: Update -->
        <mxCell id="step4" value="4. update_from_output() — append tokens, check stop" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="280" y="520" width="300" height="45" as="geometry"/>
        </mxCell>

        <!-- Queue labels on left -->
        <mxCell id="running_label" value="RUNNING&#xa;requests" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="68" width="120" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="waiting_label" value="WAITING&#xa;requests" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#70AD47;fontColor=#FFFFFF;strokeColor=#548235;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="253" width="120" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="finished_label" value="FINISHED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FF4444;fontColor=#FFFFFF;strokeColor=#CC0000;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="528" width="120" height="35" as="geometry"/>
        </mxCell>

        <!-- RUNNING → Step 1 (solid) -->
        <mxCell id="e1" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" parent="1" source="running_label" target="step1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Step 1 → Decision 1 -->
        <mxCell id="e2" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#2F5496;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="step1" target="dec1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Decision 1 → No → PREEMPT -->
        <mxCell id="e3" value="No" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#CC0000;strokeWidth=2;fontColor=#CC0000;fontStyle=1;fontSize=12;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" parent="1" source="dec1" target="preempt">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- PREEMPT → back to WAITING (clean right-side loop) -->
        <mxCell id="e3b" value="back to waiting" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#CC0000;strokeWidth=2;fontColor=#CC0000;fontStyle=2;fontSize=10;dashed=1;exitX=0.5;exitY=1;entryX=1;entryY=0.5;" edge="1" parent="1" source="preempt" target="waiting_label">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="790" y="273"/>
              <mxPoint x="230" y="273"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Decision 1 → Yes → Step 2 -->
        <mxCell id="e4" value="Yes" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;fontColor=#548235;fontStyle=1;fontSize=12;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="dec1" target="step2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- WAITING → Step 2 (solid) -->
        <mxCell id="e5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" parent="1" source="waiting_label" target="step2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Step 2 → Decision 2 -->
        <mxCell id="e6" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#2F5496;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="step2" target="dec2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Decision 2 → No → Stop -->
        <mxCell id="e7" value="No" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#757575;strokeWidth=2;fontColor=#757575;fontStyle=1;fontSize=12;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" edge="1" parent="1" source="dec2" target="stop_admit">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Decision 2 → Yes → Step 3 -->
        <mxCell id="e8" value="Yes" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;fontColor=#548235;fontStyle=1;fontSize=12;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="dec2" target="step3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Step 3 → Step 4 -->
        <mxCell id="e9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#548235;strokeWidth=2;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" edge="1" parent="1" source="step3" target="step4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Step 4 → FINISHED -->
        <mxCell id="e10" value="if done" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#CC0000;strokeWidth=2;fontColor=#CC0000;fontStyle=2;fontSize=10;exitX=0;exitY=0.5;entryX=1;entryY=0.5;" edge="1" parent="1" source="step4" target="finished_label">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Footer -->
        <mxCell id="footer" value="Ref: docs.vllm.ai/en/latest/ → Design Documents → Architecture Overview" style="text;html=1;fontSize=9;fontStyle=2;fontColor=#A5A5A5;align=center;" vertex="1" parent="1">
          <mxGeometry x="250" y="600" width="450" height="15" as="geometry"/>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
